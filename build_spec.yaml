version: 0.1
component: build
timeoutInSeconds: 600
shell: bash

env:
  variables:
    JAVA_HOME: /usr/lib64/graalvm/graalvm-java22

  exportedVariables:
    - BuildServiceDemoVersion

steps:

  - type: Command
    name: "Install GraalVM Enterprise 22.x Native Image for Java22"
    command: |
      yum -y install graalvm-22-jdk.x86_64
      ls /usr/lib64/graalvm/

  - type: Command
    name: "Build and Docker Login"
    command: |
      set -euo pipefail

      export PATH=$JAVA_HOME/bin:$PATH

      cd MtdrSpring

      # Descargar archivo con configuración
      oci os object get \
        --bucket-name reacttodo-ysmiy \
        --name deployment_config.tgz \
        --file deployment_config.tgz

      tar -xzvf deployment_config.tgz

      # Verificar que existe el token
      if [ ! -f at.cfg ]; then
        echo "ERROR: No se encontró at.cfg"
        exit 1
      fi

      echo "Iniciando login en OCIR..."

      # Login limpio (remueve CRLF por si viene de Windows)
      tr -d '\r' < at.cfg | head -n 1 | \
      docker login \
        -u ax9dxibqo6lr/a00839876@tec.mx \
        --password-stdin \
        mx-queretaro-1.ocir.io

      echo "Login exitoso."

      # Build backend
      source env.sh
      (cd backend && source build.sh)
